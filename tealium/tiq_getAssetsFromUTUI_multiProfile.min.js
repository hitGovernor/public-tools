let allTiQAssets=[],results={profiles:0,tag:0,loadrule:0,extension:0,datalayer:0},tiqHelper={getId:function(type,asset){try{return asset._id||asset.id||""}catch(err){return""}},getName:function(type,asset){try{let retval="datalayer"===type?asset.name:asset.title;return retval=retval.replace(/[,\t]/g," "),retval}catch(err){return""}},getType:function(type,asset){try{let retval="";return"datalayer"===type?retval=asset.type:"tag"===type?(retval=asset.tag_name,retval+=asset.config_tagtype?" - "+asset.config_tagtype:""):"extension"===type&&(retval=asset.extType),retval}catch(err){return""}},getStatus:function(type,asset){try{return asset.status||""}catch(err){return""}},getPublishTargets:function(type,asset){try{let retval={last_modified:asset.publish_revisions.last_modified};return Object.assign(retval,asset.publish_revisions.svr_save_timestamps),retval}catch(err){return{}}},getLastPublishDetail:function(payload,pub_date){try{let retval={},obj=payload.publish_history[pub_date][pub_date];return retval.notes=this.decodeHTMLEntities(obj.notes),retval.operator=obj.operator,retval}catch(err){return{}}},getLastModified:function(type,asset){try{return asset.publish_revisions.last_modified}catch(err){return""}},addToDataList:function(ary,key){return ary.includes(key)||ary.push(key),ary},getMappedVars:function(type,asset){let output=[];if("tag"===type)for(let mapped in asset.map)output.push(asset.map[mapped].type+"."+asset.map[mapped].key);else if("extension"===type)for(let key in asset)/_source$/.test(key)&&this.addToDataList(output,asset[key]),"Set Data Values"===asset.extType?/_set$/.test(key)&&this.addToDataList(output,asset[key]):"Lookup Table"===asset.extType?"var"!==key&&"varlookup"!==key||this.addToDataList(output,asset[key]):"Join Data Values"===asset.extType?(/_set$/.test(key)||"var"===key)&&this.addToDataList(output,asset[key]):"Persist Data Value"===asset.extType&&("var"!==key&&"settovar"!==key||this.addToDataList(output,asset[key]));else if("loadrule"===type)for(let key in asset)if("object"==typeof asset[key])for(let subkey in asset[key])/^input_/.test(subkey)&&this.addToDataList(output,asset[key][subkey]);return output=output.join("|"),output=tiqHelper.decodeHTMLEntities(output),output},getLoadRuleTagCount:function(type,asset){return"loadrule"===type?utui.loadrules.getTagsScopedCount(asset)||{}:{active:"",inactive:"",total:""}},getLoadRulesForTags:function(type,asset){return"tag"===type?asset.loadrule.replaceAll(",","|"):""},getExtensionScope:function(type,asset){return"extension"===type?asset.scope.replaceAll(",","|"):""},getLabels:function(type,asset){try{let retval=[];return asset.labels&&asset.labels.split(",").forEach((function(item){retval.push(utui.data.labels[item].name)})),asset.imported&&retval.push(asset.imported),retval.join("|")}catch(err){return""}},getParentLibrary:function(asset){try{return asset.settings.profileid}catch(err){return""}},getDoNotSellStatus:function(type,asset){try{if("tag"===type){let retval="";for(key in utui.data.privacy_management.doNotSell.categories){let tmp;if(utui.data.privacy_management.doNotSell.categories[key].tagid.forEach((function(item){if(item.id===asset.id)return retval=item.doNotSell,!1})),""!==retval)break}return retval}}catch(err){}},decodeHTMLEntities:function(str){let txt=document.createElement("textarea");return txt.innerHTML=str.replace(/[\n,]/gi,"; "),txt.value},getLoadRulesByTag:function(tags_only,loadrules_only){let loadRulesByTag=[];tags_only.forEach((function(item){let loadRules;item.tagLoadRules.split("|").forEach((function(lrule){let tmpObj={account:item.account,tagId:item.id,tagName:item.name,status:item.status,assetCategory:item.assetCategory,assetType:item.assetType,labels:item.labels,lastProdPubUser:item.lastProdPubUser,loadRuleId:lrule,parentLibrary:item.parentLibrary,profile:item.profile};loadrules_only.filter((function(lr){lr.account===item.account&&lr.profile===item.profile&&lr.id===lrule&&(tmpObj.loadRuleName=lr.name)})),loadRulesByTag.push(tmpObj)}))})),console.log("TIQ_AUDIT: LOAD RULES BY TAG",loadRulesByTag),tiqHelper.download(tiqHelper.convertToCSV(loadRulesByTag),"by-loadrule")},getDataLayerByTag:function(tags_only){let dataLayerByTag=[];tags_only.forEach((function(item){let mappedVars;item.mappedVars.split("|").forEach((function(mvar){let tmpObj={account:item.account,tagId:item.id,tagName:item.name,status:item.status,assetCategory:item.assetCategory,assetType:item.assetType,labels:item.labels,lastProdPubUser:item.lastProdPubUser,variable:mvar,parentLibrary:item.parentLibrary,profile:item.profile};dataLayerByTag.push(tmpObj)}))})),console.log("TIQ_AUDIT: DATA LAYER VARIABLES BY TAG",dataLayerByTag),tiqHelper.download(tiqHelper.convertToCSV(dataLayerByTag),"by-datalayer")},convertToCSV:function(assets){let allBody=[],headers=[];headers=Object.keys(assets[0]).join(",")+"\n";for(let item in assets){let tmp=assets[item],tmpArray=[];for(let key in tmp)tmpArray.push(tmp[key]);allBody.push(tmpArray.join(","))}return headers+allBody.join("\n")},download:function(data,suffix){tiq_account=tiqHelper.account||"";let filename="tiq-inventory-"+tiq_account+(suffix?"-"+suffix:"")+".csv";const blob=new Blob([data],{type:"text/csv"}),url=window.URL.createObjectURL(blob),a=document.createElement("a");a.setAttribute("href",url),a.setAttribute("download",filename),a.click()},getAllAssets:function(payload){let ACCOUNT=tiqHelper.account=payload.account||payload.settings.account,PROFILE=payload.profile||payload.settings.profileid,assetCategorysToRetrieve=["tag","extension","loadrule","datalayer"],retval=[],assetSources={tag:payload.manage,extension:payload.customizations,loadrule:payload.loadrules,datalayer:payload.define};return assetCategorysToRetrieve.forEach((function(assetCategory){let assets=assetSources[assetCategory];for(let key in assets){results[assetCategory]++;let tmp={},loadRuleTagCounts=tiqHelper.getLoadRuleTagCount(assetCategory,assets[key]),publishTargetsAndDates=tiqHelper.getPublishTargets(assetCategory,assets[key]),lastProdPublishDetails=tiqHelper.getLastPublishDetail(payload,publishTargetsAndDates.prod);tmp.account=ACCOUNT,tmp.profile=PROFILE,tmp.parentLibrary=tiqHelper.getParentLibrary(assets[key]),tmp.assetType=assets[key].type,tmp.assetCategory=assetCategory,tmp.id=tiqHelper.getId(assetCategory,assets[key]),tmp.name=tiqHelper.getName(assetCategory,assets[key]),tmp.lastModified=publishTargetsAndDates.last_modified||"unpublished",tmp.lastDevPubDate=publishTargetsAndDates.dev||"unpublished",tmp.lastQAPubDate=publishTargetsAndDates.qa||"unpublished",tmp.lastProdPubDate=publishTargetsAndDates.prod||"unpublished",tmp.lastProdPubUser=lastProdPublishDetails.operator||"",tmp.lastProdPubNotes=lastProdPublishDetails.notes||"",tmp.type=tiqHelper.getType(assetCategory,assets[key]),tmp.status=tiqHelper.getStatus(assetCategory,assets[key]),tmp.labels=tiqHelper.getLabels(assetCategory,assets[key]),tmp.mappedVars=tiqHelper.getMappedVars(assetCategory,assets[key]),tmp.loadRuleTagsActive=loadRuleTagCounts.active,tmp.loadRuleTagsInactive=loadRuleTagCounts.inactive,tmp.tagLoadRules=tiqHelper.getLoadRulesForTags(assetCategory,assets[key]),tmp.extensionScope=tiqHelper.getExtensionScope(assetCategory,assets[key]),tmp.doNotSell=tiqHelper.getDoNotSellStatus(assetCategory,assets[key]),allTiQAssets.push(tmp),retval.push(tmp)}})),retval}};const style=document.createElement("style");function elementCleanup(ele){ele&&ele.remove()}function showHide(ele){console.log(ele,ele.style.display),ele&&("none"===ele.style.display?ele.style.display="block":ele.style.display="none")}style.innerHTML="\n  #mytiq-inventory {\n    /*display: flex; */\n    position: fixed;\n    padding: 10px;\n    top: 50px;\n    left: 50px;\n    width: 75%;\n    height: 75%;\n    background-color: silver; /*rgba(0, 0, 0, 0.5);*/\n    justify-content: center;\n    align-items: center;\n    z-index: 999;\n    overflow: auto;\n  }\n",document.head.appendChild(style),elementCleanup(document.getElementById("mytiq-inventory"));let mytiq_form=document.createElement("form");mytiq_form.setAttribute("id","mytiq-inventory"),elementCleanup(document.getElementById("mytiq-fieldset"));let mytiq_fs=document.createElement("fieldset");mytiq_fs.id="mytiq-fieldset",elementCleanup(document.getElementById("mytiq-showhide"));let mytiq_close_modal=document.createElement("a");mytiq_close_modal.id="mytiq-showhide",mytiq_close_modal.innerHTML="Close Modal<br>",mytiq_close_modal.addEventListener("click",(function(){showHide(document.getElementById("mytiq-inventory"))})),elementCleanup(document.getElementById("mytiq-deselect"));let mytiq_deselect_all=document.createElement("a");mytiq_deselect_all.id="mytiq-deselect",mytiq_deselect_all.innerHTML="De-select All<br>",mytiq_deselect_all.addEventListener("click",(function(){document.querySelectorAll("form#mytiq-inventory input[type='checkbox']").forEach((function(item){item.checked=!1}))})),elementCleanup(document.getElementById("mytiq-select"));let mytiq_select_all=document.createElement("a");mytiq_select_all.id="mytiq-select",mytiq_select_all.innerHTML="Select All<br><br>",mytiq_select_all.addEventListener("click",(function(){document.querySelectorAll("form#mytiq-inventory input[type='checkbox']").forEach((function(item){item.checked=!0}))}));let mytiq_submit=document.createElement("input");mytiq_submit.setAttribute("type","button"),mytiq_submit.setAttribute("value","Get Inventory"),mytiq_submit.addEventListener("click",(function(){let checked,profiles=document.getElementById("mytiq-fieldset").querySelectorAll("input:checked");results={profiles:0,tag:0,loadrule:0,extension:0,datalayer:0},profiles.forEach((function(profile){utui.profile.getProfile(null,{r:"getProfile",account:utui.login.account,profile:profile.id},(function(data){tiqHelper.getAllAssets(data),results.profiles++,console.log("TIQ_AUDIT: PROCESSING",results.profiles,"of",profiles.length,data.profile,data),results.profiles>=profiles.length&&(console.log("TIQ_AUDIT: DONE",results.profiles,"of",profiles.length,results,allTiQAssets),tiqHelper.tagsOnly=allTiQAssets.filter((function(item){if("tag"===item.assetCategory)return item})),tiqHelper.loadRulesOnly=allTiQAssets.filter((function(item){if("loadrule"===item.assetCategory)return item})),!0===confirm("Download FULL inventory?")&&tiqHelper.download(tiqHelper.convertToCSV(allTiQAssets),"full"),!0===confirm("Download LOAD RULES broken out by tag?")&&tiqHelper.getLoadRulesByTag(tiqHelper.tagsOnly,tiqHelper.loadRulesOnly),!0===confirm("Download DATA LAYER variables broken out by tag?")&&tiqHelper.getDataLayerByTag(tiqHelper.tagsOnly))}))})),showHide(mytiq_form)})),utui.automator.getAllProfiles(utui.login.account).then((function(profiles){(profiles=profiles.sort()).forEach((function(profile,idx){let div=document.createElement("div");div.verticalAlign="middle";let input=document.createElement("input");input.setAttribute("type","checkbox"),input.checked=!0,input.setAttribute("id",profile),input.setAttribute("name",profile),input.setAttribute("style","margin-right: 5px");let label=document.createElement("label");label.setAttribute("for",profile),label.innerText=idx+1+" - "+profile,div.appendChild(input),div.appendChild(label),mytiq_fs.appendChild(div)}))})),mytiq_form.appendChild(mytiq_close_modal),mytiq_form.appendChild(mytiq_deselect_all),mytiq_form.appendChild(mytiq_select_all),mytiq_form.appendChild(mytiq_submit),mytiq_form.appendChild(mytiq_fs),document.body.appendChild(mytiq_form);